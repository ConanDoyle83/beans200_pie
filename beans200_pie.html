<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>タリーズ｜豆200g 年間比率（袋数）円グラフ</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- %表示用：DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    *{ box-sizing:border-box; }
    :root{
      --bg1:#2b1b12; --bg2:#1f120c;
      --card:#fff8ef; --card2:#fff3e1;
      --text:#2a1a12; --muted:#6e574b;
      --line:rgba(42,26,18,.14);
      --shadow:0 16px 34px rgba(0,0,0,.28);
      --accent:#7a1f2b; --accent2:#5f1620;
      --danger:#b23a3a;
      --radius:16px;
    }
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(1200px 500px at 10% -10%, rgba(255,255,255,.07), transparent 60%),
                  linear-gradient(160deg,var(--bg1),var(--bg2));
      color:#fff;
    }
    header{
      position:sticky; top:0; z-index:30;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.25));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .header-inner{
      max-width:1200px; margin:0 auto;
      padding:12px 14px;
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
    }
    .brand{ display:flex; gap:10px; align-items:baseline; font-weight:900; }
    .brand small{ opacity:.75; font-weight:700; }
    .header-actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }
    input[type="number"]{
      font: inherit;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color:#fff;
      padding:8px 10px;
      outline:none;
      width: 120px;
      text-align:right;
    }
    button{
      font: inherit;
      cursor:pointer;
      border:0;
      border-radius:12px;
      padding:10px 12px;
      color:#fff;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      white-space:nowrap;
    }
    button.secondary{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
    }
    button.danger{ background: rgba(178,58,58,.88); }

    main{ max-width:1200px; margin:0 auto; padding:14px; }
    .grid{ display:grid; grid-template-columns: 1.25fr .95fr; gap:12px; }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg,var(--card),var(--card2));
      color:var(--text);
      border:1px solid rgba(255,255,255,.28);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:12px 14px;
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .card-title{ font-weight:900; letter-spacing:.02em; }
    .card-sub{ font-size:12px; color:var(--muted); }
    .card-body{ padding:12px 14px; }

    .chart-title-line{
      margin: 0 0 8px;
      font-weight: 900;
      color: var(--text);
      letter-spacing: .01em;
    }

    .chart-box{
      background:#fff;
      border:1px solid rgba(42,26,18,.12);
      border-radius:14px;
      padding:10px;

      /* ✅ 凡例+外側%のために高さ確保（被り対策で少し高め） */
      min-height: 520px;

      overflow: visible;
    }
    .chart-box canvas{ width:100% !important; height:480px !important; }

    .table-wrap{
      overflow:auto;
      border:1px solid rgba(42,26,18,.12);
      border-radius:12px;
      background:#fff;
    }
    table{
      width:max-content; min-width:100%;
      border-collapse:separate;
      border-spacing:0;
      color:var(--text);
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid rgba(42,26,18,.10);
      border-right:1px solid rgba(42,26,18,.08);
      padding:8px 8px;
      white-space:nowrap;
    }
    th:first-child, td:first-child{
      position:sticky; left:0; background:#fff; z-index:2;
      min-width:240px;
    }
    thead th{
      position:sticky; top:0; z-index:3;
      background:#fff;
      font-size:12px; color:var(--muted);
    }
    thead th:first-child{ z-index:4; }

    .name-cell{ display:flex; align-items:center; gap:8px; }
    .name-chip{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.18);
      flex:0 0 auto;
    }
    .name-text{ font-weight:800; }
    .num-input{
      width:86px;
      border:1px solid rgba(42,26,18,.18) !important;
      background:#fff !important;
      color:var(--text) !important;
      padding:7px 8px !important;
      border-radius:10px !important;
      outline:none !important;
      text-align:right;
      font: inherit;
    }

    .kpi{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:10px;
    }
    .kpi .box{
      flex:1 1 170px;
      background: rgba(255,255,255,.75);
      border:1px solid rgba(42,26,18,.12);
      border-radius: 14px;
      padding:10px 12px;
    }
    .kpi .t{ font-size:11px; color:var(--muted); }
    .kpi .v{ font-size:16px; font-weight:900; margin-top:2px; }
    .hint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.70);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      max-width:min(92vw, 820px);
      white-space:nowrap;
      overflow:hidden; text-overflow:ellipsis;
      z-index:120;
    }
    .toast.show{ opacity:1; }
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="brand">
      豆200g 年間比率 <small>（袋数 / 円グラフ / PNG出力）</small>
    </div>
    <div class="header-actions">
      <div style="display:flex; gap:8px; align-items:center;">
        <span style="opacity:.85; font-size:12px;">年</span>
        <input id="yearInput" type="number" inputmode="numeric" min="2000" max="2100" />
      </div>
      <button id="btnSave" type="button">保存</button>
      <button id="btnRender" class="secondary" type="button">グラフ更新</button>
      <button id="btnDownloadPng" class="secondary" type="button">PNGダウンロード</button>
      <button id="btnClearYear" class="danger" type="button">この年リセット</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <section class="card">
      <div class="card-head">
        <div>
          <div class="card-title">入力（豆200g：月ごとの袋数）</div>
          <div class="card-sub">1月〜12月を埋めていくだけ。年は「暦年」で管理。</div>
        </div>
      </div>
      <div class="card-body">
        <div class="table-wrap" id="tableWrap"></div>

        <div class="kpi">
          <div class="box">
            <div class="t">年間合計（袋）</div>
            <div class="v" id="kpiTotal">0</div>
          </div>
          <div class="box">
            <div class="t">種類数（0除外）</div>
            <div class="v" id="kpiKinds">0</div>
          </div>
          <div class="box">
            <div class="t">最大シェア</div>
            <div class="v" id="kpiTop">—</div>
          </div>
        </div>

        <div class="hint">
          ・保存先：このブラウザの localStorage（端末ごと）<br>
          ・外側％は「上半分だけ」／下半分は凡例に被らんよう“内側（中心寄せ）”に切り替え
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-head">
        <div>
          <div class="card-title">円グラフ（豆の種類別）</div>
          <div class="card-sub">この年の合計袋数をもとに比率表示（％ラベル付き）。</div>
        </div>
      </div>
      <div class="card-body">
        <div id="chartTitleLine" class="chart-title-line"></div>
        <div class="chart-box">
          <canvas id="pieChart"></canvas>
        </div>
        <div class="hint">
          ※ 色は提示コードの COLOR_FIXED をそのまま使用（未知の豆はグレー）
        </div>
      </div>
    </section>

  </div>
</main>

<div class="toast" id="toast"></div>

<script>
/** ===== 豆名・色 ===== */
const MONTHS = ["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];

const FIXED_BEANS200 = [
  "ハウスブレンド","ピッコロバンビーノ","ブラジルファゼンダバウ","コスタリカ","モカジャバ",
  "ブラックスリー","カフェオレモナーレ","エスプレッソクラシコ","フレンチロースト",
  "キリマンジャロ　スイート","オーガニック　デカフェ",
];

const COLOR_FIXED = {
  "ハウスブレンド": "#0f5132",
  "ピッコロバンビーノ": "#7fbf7f",
  "ブラジルファゼンダバウ": "#ffff00",
  "コスタリカ": "#f39c12",
  "モカジャバ": "#c9a24d",
  "ブラックスリー": "#0f0f0f",
  "カフェオレモナーレ": "#e6d3b1",
  "エスプレッソクラシコ": "#3b2416",
  "フレンチロースト": "#c71585",
  "キリマンジャロ　スイート": "#0000ff",
  "オーガニック　デカフェ": "#e6e6fa",
  "シーズナル合計": "#bfa24a",
};

function normalizeName(s){
  return String(s || "").replace(/\u3000/g, " ").replace(/\s+/g, " ").trim();
}
function getColorForLabel(label){
  const n = normalizeName(label);
  for(const k in COLOR_FIXED){
    if(normalizeName(k) === n) return COLOR_FIXED[k];
  }
  return "#64748b";
}

/** ===== 永続化（既存データ保持のため絶対変えない） ===== */
const STORAGE_KEY = "tully_beans200_pie_v1";

function loadDB(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { years:{} };
    const parsed = JSON.parse(raw);
    if(!parsed || typeof parsed !== "object") return { years:{} };
    if(!parsed.years) parsed.years = {};
    return parsed;
  }catch(e){
    return { years:{} };
  }
}
function persistDB(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
  catch(e){}
}
let db = loadDB();

/** ===== UI ===== */
const $ = (id) => document.getElementById(id);
const toastEl = $("toast");
const yearInput = $("yearInput");
const tableWrap = $("tableWrap");
let pieChart = null;

/** ===== init ===== */
yearInput.value = String(new Date().getFullYear());
openYear(getYear());
wireEvents();

function getYear(){
  const n = Number(String(yearInput.value || "").trim());
  if(Number.isFinite(n) && n >= 2000 && n <= 2100) return String(n);
  return "";
}
function requireYear(){
  const y = getYear();
  if(!y){ toast("年を入れてな（例：2025）"); yearInput.focus(); return null; }
  return y;
}

function ensureYearState(year){
  if(!db.years) db.years = {};
  if(!db.years[year]){
    const fixed = {};
    FIXED_BEANS200.forEach(n => fixed[n] = Array(12).fill(0));
    db.years[year] = { year, beans200: fixed };
    persistDB();
  }else{
    const st = db.years[year];
    if(!st.beans200) st.beans200 = {};
    FIXED_BEANS200.forEach(n => {
      if(!Array.isArray(st.beans200[n])) st.beans200[n] = Array(12).fill(0);
    });
  }
}

function openYear(year){
  if(!year) return;
  ensureYearState(year);
  buildTable(year);
  renderPie(year);
}

function buildTable(year){
  const st = db.years[year];
  let html = `<table>
    <thead>
      <tr>
        <th>豆200g（袋数）</th>
        ${MONTHS.map(m=>`<th>${m}</th>`).join("")}
        <th>年計</th>
      </tr>
    </thead>
    <tbody>
  `;

  for(const name of FIXED_BEANS200){
    const col = getColorForLabel(name);
    html += `<tr data-bean="${escAttr(name)}">
      <td>
        <div class="name-cell">
          <span class="name-chip" style="background:${col}"></span>
          <span class="name-text">${esc(name)}</span>
        </div>
      </td>
      ${Array.from({length:12}).map((_,i)=>`
        <td>
          <input class="num-input" type="number" min="0" step="1" inputmode="numeric"
            data-bean="${escAttr(name)}" data-month="${i}" value="${Number(st.beans200[name][i]||0)}" />
        </td>
      `).join("")}
      <td class="right" data-year-sum="${escAttr(name)}" style="text-align:right; font-weight:900;">0</td>
    </tr>`;
  }

  html += `</tbody></table>`;
  tableWrap.innerHTML = html;

  tableWrap.querySelectorAll("input.num-input").forEach(inp => {
    inp.addEventListener("focus", () => requestAnimationFrame(() => inp.select()));
    inp.addEventListener("input", () => {
      sanitizeNumInput(inp);
      saveFromTable(year, true);
      renderPie(year);
    });
  });

  updateYearSums(year);
}

function saveFromTable(year, silent){
  const st = db.years[year];
  tableWrap.querySelectorAll("input.num-input").forEach(inp => {
    const bean = inp.getAttribute("data-bean");
    const m = Number(inp.getAttribute("data-month")||0);
    if(!bean) return;
    st.beans200[bean][m] = numVal(inp.value);
  });
  persistDB();
  updateYearSums(year);
  if(!silent) toast("保存した");
}

function updateYearSums(year){
  const st = db.years[year];
  for(const bean of FIXED_BEANS200){
    const sum = (st.beans200[bean]||[]).reduce((a,b)=>a+Number(b||0),0);
    const cell = tableWrap.querySelector(`[data-year-sum="${cssEsc(bean)}"]`);
    if(cell) cell.textContent = String(sum);
  }
}

/** ===== Pie（ピッコロにも被らん版） ===== */
function renderPie(year){
  const st = db.years[year];

  const labels = [];
  const values = [];
  for(const bean of FIXED_BEANS200){
    const sum = (st.beans200[bean]||[]).reduce((a,b)=>a+Number(b||0),0);
    if(sum > 0){
      labels.push(bean);
      values.push(sum);
    }
  }

  const total = values.reduce((a,b)=>a+b,0);
  const kinds = values.length;

  $("kpiTotal").textContent = String(total);
  $("kpiKinds").textContent = String(kinds);

  if(total > 0){
    let topIdx = 0;
    for(let i=1;i<values.length;i++) if(values[i] > values[topIdx]) topIdx = i;
    const topName = labels[topIdx];
    const topShare = (values[topIdx]/total*100).toFixed(1);
    $("kpiTop").textContent = `${topName}（${topShare}%）`;
  }else{
    $("kpiTop").textContent = "—";
  }

  $("chartTitleLine").textContent = `豆200g 年間比率（袋数）｜${year}年`;

  const bg = labels.map(l => getColorForLabel(l));
  const ctx = $("pieChart");

  if(pieChart) pieChart.destroy();

  pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: bg,
        borderColor: "rgba(0,0,0,.12)",
        borderWidth: 1,

        /* ✅ 円を少し小さくして凡例との距離を稼ぐ（被り対策） */
        radius: "78%"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,

      /* ✅ 凡例が下にあるので、下余白をさらに確保（ここが効く） */
      layout: {
        padding: { top: 28, right: 38, bottom: 130, left: 38 }
      },

      plugins: {
        legend: {
          position: "bottom",
          labels: {
            boxWidth: 12,
            boxHeight: 12,
            padding: 14
          }
        },

        title: { display: false },

        tooltip: {
          callbacks: {
            label: (c) => {
              const v = c.parsed;
              const r = total > 0 ? (v/total*100) : 0;
              return `${c.label}: ${v}袋（${r.toFixed(1)}%）`;
            }
          }
        },

        /** ✅ %ラベル：上半分=外側、下半分=中心寄せ（凡例と絶対かぶらん） */
        datalabels: {
          display: (context) => {
            const v = context.dataset.data[context.dataIndex] || 0;
            if(total <= 0) return false;
            return (v / total) >= 0.01; // 1%未満は非表示（必要なら0に）
          },

          formatter: (value) => {
            if(total <= 0) return "";
            const p = value / total * 100;
            return `${p.toFixed(1)}%`;
          },

          // ✅ “下側”は強制的に中心へ寄せる
          anchor: (context) => {
            const meta = context.chart.getDatasetMeta(context.datasetIndex);
            const arc = meta?.data?.[context.dataIndex];
            if(!arc) return "end";
            const mid = (arc.startAngle + arc.endAngle) / 2;
            const isBottom = Math.sin(mid) > 0; // 下半分
            return isBottom ? "center" : "end";
          },

          align: (context) => {
            const meta = context.chart.getDatasetMeta(context.datasetIndex);
            const arc = meta?.data?.[context.dataIndex];
            if(!arc) return "end";
            const mid = (arc.startAngle + arc.endAngle) / 2;
            const isBottom = Math.sin(mid) > 0;
            return isBottom ? "center" : "end";
          },

          offset: (context) => {
            const meta = context.chart.getDatasetMeta(context.datasetIndex);
            const arc = meta?.data?.[context.dataIndex];
            if(!arc) return 10;
            const mid = (arc.startAngle + arc.endAngle) / 2;
            const isBottom = Math.sin(mid) > 0;
            return isBottom ? 0 : 10;
          },

          clamp: true,
          clip: false,

          color: "#111",
          backgroundColor: "rgba(255,255,255,.92)",
          borderColor: "rgba(0,0,0,.10)",
          borderWidth: 1,
          borderRadius: 8,
          padding: { top: 4, right: 6, bottom: 4, left: 6 },
          font: { weight: "900", size: 12 }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

/** ===== PNG DL（canvasだけDL） ===== */
function downloadPng(){
  if(!pieChart){ toast("グラフがまだないで"); return; }
  const year = getYear() || "year";
  const url = pieChart.toBase64Image("image/png", 1);
  const a = document.createElement("a");
  a.href = url;
  a.download = `beans200_pie_${year}.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/** ===== Events ===== */
function wireEvents(){
  $("btnSave").addEventListener("click", () => {
    const y = requireYear(); if(!y) return;
    ensureYearState(y);
    saveFromTable(y, false);
    toast("保存した");
  });

  $("btnRender").addEventListener("click", () => {
    const y = requireYear(); if(!y) return;
    ensureYearState(y);
    saveFromTable(y, true);
    renderPie(y);
    toast("グラフ更新した");
  });

  $("btnDownloadPng").addEventListener("click", () => {
    const y = requireYear(); if(!y) return;
    downloadPng();
  });

  $("btnClearYear").addEventListener("click", () => {
    const y = requireYear(); if(!y) return;
    if(!confirm(`${y}年の豆200g入力を全部ゼロに戻すで。ほんまに？`)) return;
    const fixed = {};
    FIXED_BEANS200.forEach(n => fixed[n] = Array(12).fill(0));
    db.years[y] = { year:y, beans200: fixed };
    persistDB();
    openYear(y);
    toast(`${y}年をリセットした`);
  });

  yearInput.addEventListener("change", () => {
    const y = requireYear(); if(!y) return;
    openYear(y);
    toast(`${y}年を開いた`);
  });
}

/** ===== 小物 ===== */
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1300);
}
function sanitizeNumInput(inp){
  if(inp.value === "") return;
  const n = Number(inp.value);
  if(!Number.isFinite(n) || n < 0) inp.value = "0";
}
function numVal(v){
  const s = String(v||"").trim();
  if(s==="") return 0;
  const n = Number(s);
  if(!Number.isFinite(n) || n < 0) return 0;
  return Math.round(n);
}
function esc(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function escAttr(s){ return String(s).replace(/"/g, "&quot;"); }
function cssEsc(s){ return String(s).replace(/(["\\#.:\\[\\]\\s])/g, "\\$1"); }
</script>
</body>
</html>
